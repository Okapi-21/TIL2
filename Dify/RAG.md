## RAG

------

### RAGとは

　RAG（retrieval-augmented Generation）は大規模言語モデルの能力を特定のデータセットや知識ベースで補強する技術のことを示している。簡単に言えば、AIに「参考書」を与えて、その内容に基づいて回答させる仕組みということになる。

　ある質問者が会社独自の情報を尋ねた場合、その内容をLLMが学習していなければ、答えが得られないか、あるいは「インチキ」な回答をしてしまう可能性がある、そこで必要になってくるのがRAGなのである。データ量がさほど多くない場合はLLMのプロンプトの中に直接入れてしまえば問題ないが、膨大なデータの中から特定の情報だけを抜き取って回答を得たい場合、そのデータ全てをプロンプトとして打ち込もうとするとLLMが許容できるデータ量をあっさり超えてしまう。RAGでは、元々のデータを適切な大きさに分割し、DBに保存しておいて、質問が来た時に「その答えに近い内容」を検索する形でリクエストに対応している。
　なお、データをAIが理解できる形に変換することを「ベクトル化」と呼び、変換されたデータを「ベクトルデータベース」もしくは、「ナレッジベース」と呼ぶ。

### RAGのポイントは入力データの正規化

　PDFヤwordファイルでも、RAGで利用するにはテキスト化が必須になるが、単にテキストとして与えるだけでは不十分であり、大きな文章を丸ごと放り込むのではなく、適度な大きさに「切り分け」てあげる必要がある。RAGではこの切り分けを「チャンク」と呼び、とても重要な作業になる。

　切り分け方としては、余計のものを取り除き、意味ある単位で分割していけばよい。これがRAGの精度を上げる最初の最も大切なステップになる。例えば、「余計な装飾タグを削除する」「適切な区切り位置の設定をする」「文脈をできるだけ保つように分割する」といった作業を行い、データをきれいに整えると、RAGはより正確に、より自然に情報を引き出してくれる。

AIに以下のプロンプトを打ち込むことで、データをパラグラフ化してくれる。

```
500 〜 1000 文字程度の意味のあるチャンクに分割をしてマークダウン形式のテキストとして出
力してください。
ルビは飛ばして本文のみを抽出します。原文は省略せずそのままで出力してください。
結果はアーティファクトとして出力してください。
区切り文字は ### としてチャンクのヘッダーに短い要約文をいれます。
```



### ハイブリッド検索

##### リランク

　リランクとはAIによる検索結果の再判定のこと。最初にベクトル検索で出てきた複数の候補をもう一回LLMにかけて、本当にユーザーの意図に近いものだけを上位に持ってくることで、結果的に生成される回答の精度が上がり、ノイズが減る。

リランクを使用するためには、それに対応したLLMが必要になってくる（Cohere）https://dashboard.cohere.com/api-keys

##### ハイブリット検索

　類似度検索（ベクトル検索）＋リランキングだけでも十分効果は高いが、RAGの精度をさらに高めるためには、これらの手法に加えて、別の検索方法を組み合わせることが効果的である。これを「ハイブリット検索」と呼ぶ。
　ハイブリット検索では「類似検索」「リランキング」「全文検索」の長所と短所を補う形で検索を行うことができるので、検索結果の網羅性が向上する。類似度検索で取りこぼされる可能性のある文書も、全文検索によってカバーすることができ、関連性の高い文書を見逃すリスクが低減される。
　また、異なる検索手法の結果を組み合わせることで、より多角的な観点から文書の関連性を評価することができるので、単一的な手法では捉えることのできない複雑な関連性も考慮することが可能となり、検索精度が向上する。
　
　具体的なdifyの操作としては、ナレッジの設定画面から「ハイブリット検索」を選択し、パラメータを設定するだけである。

