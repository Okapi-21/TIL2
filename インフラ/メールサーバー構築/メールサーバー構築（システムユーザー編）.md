# メールサーバー構築（システムユーザー編）

前回の記事では、メールサーバーがどのような仕組みで動いているのかを解説しました。  
今回は、実際に自分でメールサーバーを構築する手順を、初めての方でも分かりやすいように説明していきます。  
「どんなソフトを入れるの？」「どの順番で作業するの？」といった疑問に答えながら、一つずつステップを進めていきましょう。

---

## ゴールの確認

今回の目標は、「自分のサーバーでメールの送受信をできるようにする」ことです。  
本格的には“仮想ユーザー”という仕組みを使うのが理想ですが、まずはシステムユーザー（Linuxのユーザーアカウント）で動かすことから始めます。これでも十分メールの流れを体験できます。

---

## 構築する環境

ここでは、Red Hat系のLinux（たとえばCentOSやAlmaLinuxなど）を使って進めます。  
もしUbuntuなどDebian系の場合は、コマンドが少し違うことがあるので注意してください。

---

## 1. Linuxを最新の状態にする

まずは、サーバーのソフトを最新にしましょう。これで後のトラブルを防ぐことができます。

```bash
sudo yum update
```
このコマンドは、Linuxに入っているすべてのソフトウェアを最新バージョンにアップデートします。

---

## 2. 必要なソフトウェアをインストールする

### Apache（Webサーバー）

メールをWeb画面から使うために、ApacheというWebサーバーを入れます。

```bash
sudo yum install httpd
```
これでWebページを表示できるようになります。

### PHPと関連モジュール

Roundcube（Webメール）の本体はPHPという言語で作られています。下記のコマンドでPHPと必要な追加機能を入れましょう。

```bash
sudo yum install php php-mbstring php-xml php-mysqlnd php-intl php-json php-common php-gd
```
- `php`：プログラム本体
- `php-mbstring`：日本語メールなど多言語対応
- `php-xml`：XMLデータのやり取り用
- `php-mysqlnd`：データベース接続用
- `php-intl`：多言語・日付処理など
- `php-json`：JSONデータ処理
- `php-common`, `php-gd`：画像処理など

### MariaDB（データベース）

メールアカウントや設定データを保存するために、MariaDB（MySQLと同じ系統のデータベース）を入れます。

```bash
sudo yum install mariadb-server
```

### unzipコマンド

Roundcubeのファイルを展開するために必要です。

```bash
sudo yum install unzip
```

---

## 3. サービスを自動起動する設定

パソコンの電源を入れるたびに自動でサービスが立ち上がるように設定します。

```bash
sudo systemctl enable --now httpd
sudo systemctl enable --now mariadb
sudo systemctl enable --now php-fpm
```
- `enable`は「自動起動を設定」
- `--now`は「今すぐ起動する」意味です

---

## 4. Roundcube本体のダウンロードと設置

### 作業用ディレクトリに移動

```bash
cd /tmp
```
ここは一時的なファイル作業場所です。

### Roundcubeのダウンロード

```bash
wget https://github.com/roundcube/roundcubemail/releases/download/1.6.7/roundcubemail-1.6.7-complete.tar.gz
```
- `wget`はインターネットからファイルをダウンロードするコマンドです。

### ファイルの展開

```bash
tar zxvf roundcubemail-1.6.7-complete.tar.gz
```
- 圧縮ファイルを解凍します。

### Web公開ディレクトリへ移動・所有権変更

```bash
sudo mv roundcubemail-1.6.7 /var/www/html/roundcube
sudo chown -R apache:apache /var/www/html/roundcube
```
- Webサーバーがファイルを正しく読み書きできるようになります。

---

## 5. ファイアウォールの設定

外部からWebサーバーやメールサーバーにアクセスできるようにします。

```bash
sudo firewall-cmd --list-all
```
今の設定を確認します。

もしHTTP（Web通信）が許可されていなければ、追加します。

```bash
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --reload
sudo firewall-cmd --list-all
```

---

## 6. ディレクトリ・ファイルの権限設定＆SELinux対策

ファイルやフォルダの権限を安全に設定します。

```bash
sudo chown -R apache:apache /var/www/html/roundcube
sudo find /var/www/html/roundcube -type d -exec chmod 755 {} \;
sudo find /var/www/html/roundcube -type f -exec chmod 644 {} \;
```
- ディレクトリ：755（読み・書き・実行）
- ファイル：644（読み・書き）

また、SELinux（Linuxのセキュリティ機能）が強すぎて動かない場合は、一時的に弱めます。

```bash
sudo setenforce 0
```
本番運用では、SELinuxの設定をきちんと見直すことをおすすめします。

---

## 7. データベースの設定

### MariaDBにログイン

```bash
mysql -u root -p
```
パスワードを入力して管理者として入ります。

### データベース・ユーザー作成

```sql
CREATE DATABASE roundcube DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
CREATE USER 'roundcube_user'@'localhost' IDENTIFIED BY 'password123';
GRANT ALL PRIVILEGES ON roundcube.* TO 'roundcube_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```
- Roundcube用のデータベースとユーザーを作成します。

### 初期化SQLの流し込み

```bash
mysql -u roundcube_user -p roundcube < /var/www/html/roundcube/SQL/mysql.initial.sql
```
- Roundcubeの必要なテーブルを作ります。

---

## 8. SMTPサーバー（Postfix）の設定

### インストールと起動

```bash
sudo yum install -y postfix
sudo systemctl enable --now postfix
sudo systemctl status postfix
```
- Postfixはメールを送信するためのサーバーです。

### 587番ポート（submission）の設定

メールソフトから安全にメールを送るには、587番ポートを使います。

1. 設定ファイル`/etc/postfix/master.cf`を編集し、「submission ...」の行のコメント（#）を外します。
2. 設定を反映するために再起動します。

```bash
sudo systemctl restart postfix
```

3. ポートが開いているか確認します。

```bash
sudo ss -tlnp | grep 587
```

### PostfixとDovecotの接続設定

`/etc/postfix/main.cf`に以下を追加します。これでメール送信時の認証ができます。

```
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_tls_auth_only = yes
smtpd_sasl_security_options = noanonymous
```

再起動で反映します。

```bash
sudo systemctl restart postfix
```

---

## 9. IMAPサーバー（Dovecot）の設定

### インストールと起動

```bash
sudo yum install -y dovecot
sudo systemctl enable --now dovecot
sudo systemctl status dovecot
```
- Dovecotはメールを受信するためのサーバーです。

### 認証設定

`/etc/dovecot/conf.d/10-master.conf`の「service auth」部分を下記のように設定します。

```
service auth {
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  }
  auth_mechanisms = plain login
}
```

設定を反映します。

```bash
sudo systemctl restart dovecot
```

---

## 10. ファイアウォールの追加設定

IMAP（メール受信）やSMTP（送信）など、メール用の通信も許可します。

```bash
sudo firewall-cmd --permanent --add-service=imap
sudo firewall-cmd --permanent --add-service=imaps
sudo firewall-cmd --permanent --add-service=smtp
sudo firewall-cmd --permanent --add-service=smtps
sudo firewall-cmd --permanent --add-service=submission
sudo firewall-cmd --reload
```

---

## 11. Roundcubeの設定

### IMAP（メール受信）設定例

- imap_host: localhost:143
- auto_create_user: 有効（ON）
- sent_mbox: Sent
- trash_mbox: Trash
- drafts_mbox: Drafts
- junk_mbox: Junk

### SMTP（メール送信）設定例

- smtp_host: localhost:587
- smtp_user: %u
- smtp_pass: %p

### おすすめプラグイン

- archive: メールをアーカイブするボタン
- attachment_reminder: 添付忘れの警告
- managesieve: 自動仕分け（フィルタ）の管理
- markasjunk: 迷惑メールボタン
- password: パスワード変更
- newmail_notifier: 新着通知

---

## 12. Roundcubeの暗号化設定と証明書

安全にメールをやりとりするため、自己署名証明書を使ったSSL/TLSの設定をします。

`config/config.inc.php`の例：

```php
$config['smtp_conn_options'] = [
  'ssl' => [
    'verify_peer' => false,
    'verify_peer_name' => false,
    'allow_self_signed' => true,
  ],
];
$config['imap_conn_options'] = [
  'ssl' => [
    'verify_peer' => false,
    'verify_peer_name' => false,
    'allow_self_signed' => true,
  ],
];
```

証明書の作成（Linuxコマンド）：

```bash
sudo yum install mod_ssl
sudo openssl req -new -x509 -days 365 -nodes \
  -out /etc/pki/tls/certs/localhost.crt \
  -keyout /etc/pki/tls/private/localhost.key
```
- これで安全な通信ができるようになります。

---

## まとめ

このように、Linuxサーバーに必要なソフトウェアをインストールし、設定を一つずつ進めていくことで、基本的なメールサーバー環境を構築できます。  
最初は難しく感じるかもしれませんが、コマンドの意味を確認しながら手順通りに進めていけば、必ず自分のメールサーバーを動かすことができます。  
次のステップでは、仮想ユーザー対応やセキュリティの強化など、さらに発展的な環境構築にも挑戦してみてください。