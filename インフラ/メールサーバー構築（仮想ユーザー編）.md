## メールサーバ構築（virtual_user編）

## STEP1: SQLのDB設定

1. **データベース作成例（MySQL/MariaDBの場合）**

```sql
CREATE DATABASE mailserver;
CREATE USER 'mailuser'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON mailserver.* TO 'mailuser'@'localhost';
FLUSH PRIVILEGES;
```

　SQL「mailserver」という名前のデータベースを作成する。
この時、このデータベースの管理権限を持つユーザを作成し、そのユーザーを用いて、サーバーにアクセスするようにする。
ルートユーザーでサーバーにアクセスしてしまうと、サーバーの乗っ取り等が発生した場合にDBサーバー上に存在する全てのデータベース、テーブルにアクセス可能となってしまうので、管理権限を有する別のユーザーを作成する。
「GRANT」＝　ユーザーに権限を与えるコマンド
「FLUSH➕PRIVILEGES」　＝ privileges（権限）の反映

2. **ユーザーテーブル例**

```sql
USE mailserver;

CREATE TABLE virtual_users (
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL
);

CREATE TABLE virtual_domains (
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE virtual_aliases (
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    domain_id INT NOT NULL,
    source VARCHAR(100) NOT NULL,
    destination VARCHAR(100) NOT NULL
);
```

3. **テストデータ追加例**

```sql
INSERT INTO virtual_domains (name) VALUES ('example.com');
INSERT INTO virtual_users (email, password) VALUES ('user1@example.com', ENCRYPT('password'));
```

> ※ `ENCRYPT('password')` の部分はPostfix/Dovecotの設定に応じて適切なハッシュ関数（`MD5`, `SHA512-CRYPT`, `bcrypt` など）をご利用ください。
>
> ＊下記は`SHA512-CRYPT`のハッシュ関数を使った暗号化を行うためのコード
> 　入力した後にパスワードの入力が求められる。入力した値はハッシュ関数の定義に基づいて、暗号化される。
>
> ```
> mkpasswd --method=sha-512 --salt=49QnLxb5EoKamiL8
> ```



4. **Dovecot/Postfix側のSQL設定例**  
`/etc/dovecot/dovecot-sql.conf.ext` や `/etc/postfix/main.cf` で  
SQL認証の接続情報を記述します。

```conf
# Dovecot例

#MYSQLというデータベースを使って、ユーザー情報を管理する
driver = mysql
＃DBの接続情報の記述(ホスト, DBの名前, アクセスユーザー/パスワード)
connect = host=localhost dbname=mailserver user=mailuser 
password=password
#パスワードの暗号化方法の記述
default_pass_scheme = SHA512-CRYPT
#メールユーザーの情報をDBから抜き出すためのSQL文
#'/var/mail/vmail/%d/%n/Maildir/'メールボックスのパス名（%d: どめいん名, %n: ユーザー名）
#5000 AS uid, 5000 AS gid LinuxのユーザーID・グループIDを5000に設定
#virtual_users」テーブルから、「email」が%u（ログイン時のメールアドレス）と一致するユーザーの情報を取得
user_query = SELECT '/var/mail/vmail/%d/%n/Maildir/' AS home, 5000 AS uid, 5000 AS gid FROM virtual_users WHERE email='%u'
#ログインしようとしたユーザーのメールアドレスとパスワードをDBがら取得する。
password_query = SELECT email as user, password FROM virtual_users WHERE email='%u'
```

---

#### 補足
- DB作成・テーブル設計・データ投入・サーバ設定を一連で行うことで、バーチャルユーザーのメール認証が可能になります。
- SQLのパスワードハッシュ方式とDovecot/Postfix側の`default_pass_scheme`が一致していることを確認してください。

## STEP2: DovecotのSQL認証設定

## 意味・目的
Dovecot（メール認証サーバー）にバーチャルユーザーDB（SQL）を使わせる設定を行うことで、DBに登録したメールアドレス/パスワードで認証できるようになる。

---

## 1. `/etc/dovecot/dovecot-sql.conf.ext` の作成・編集

このファイルに「DB接続情報」「認証クエリ」を記載する。

```ini
driver = mysql
connect = host=localhost dbname=mailserver user=mailuser password=mailpassword

default_pass_scheme = SHA512-CRYPT

password_query = SELECT email AS user, password FROM virtual_users WHERE email = '%u';
user_query = SELECT email AS user, '/var/mail/vmail/%d/%n' AS home, 'vmail' AS uid, 'vmail' AS gid FROM virtual_users WHERE email = '%u';
```

---

## 2. パーミッション設定

セキュリティのため、ファイル所有者・権限を下記コマンドで変更する。

```bash
sudo chown root:dovecot /etc/dovecot/dovecot-sql.conf.ext
sudo chmod 600 /etc/dovecot/dovecot-sql.conf.ext
```

chown : ファイルの所有者を変更する（ change owner）
ファイルの所有者を「ルート」、グループを「dovecot」とする。
＊（linuxではグループごとに権限を付与することが可能）
＊ 一々、ユーザーに権限を渡していると面倒だからね

chmod：ファイルの権限を変更する（ change mode）
このファイルは所有者のみが読み書き可能な状態にする。

＜Linux　MEMO＞

Linuxでは、ファイルやフォルダに「誰が何をできるか」を**数字（3桁）**で指定します。
この数字は「パーミッション（アクセス権）」と呼ばれます。

### 権限の3つの区分

- **所有者（User/Owner）** … ファイルの持ち主
- **グループ（Group）** … 持ち主が属するグループのメンバー
- **その他（Others）** … それ以外の人

### 数字の意味

各区分に対して「権限」を**数字（0～7）**で表します。

| 数字 | 権限             | 内容 |
| ---- | ---------------- | ---- |
| 7    | 読み・書き・実行 | rwx  |
| 6    | 読み・書き       | rw-  |
| 5    | 読み・実行       | r-x  |
| 4    | 読み             | r--  |
| 3    | 書き・実行       | -wx  |
| 2    | 書き             | -w-  |
| 1    | 実行             | --x  |
| 0    | 何もできない     | ---  |

**例:**

- `600` → 所有者だけ「読み・書き」ができる。他の人は何もできない
- `644` → 所有者は「読み・書き」、グループとその他は「読みだけ」
- `755` → 所有者は「全部できる」、他の人は「読み・実行だけ」

---

## 3. `/etc/dovecot/conf.d/10-auth.conf` の編集

下記の記述が有効になっていることを確認（コメントアウトされていれば外す）。

```conf
!include auth-sql.conf.ext
```

---

## 4. `/etc/dovecot/conf.d/auth-sql.conf.ext` の確認

ファイル内で以下の記述があることを確認。

```
args = /etc/dovecot/dovecot-sql.conf.ext
```

**args** は「引数（argument）」という意味
`= /etc/dovecot/dovecot-sql.conf.ext`は、「dovecot-sql.conf.extというファイル」を引数として指定
つまり、auth-sql.cong.extはdovecotの認証機能を示すものであるので、「認証」にはこのファイルを使ってくれ、ということを言っている。

---

## 5. Dovecotの設定再読み込み/再起動

設定反映のため、下記コマンドでDovecotをリロードまたは再起動する。

```bash
sudo systemctl reload dovecot
# または
sudo systemctl restart dovecot
```

---

## 補足
- DB接続情報（DB名/ユーザー/パスワード）は自身の環境に合わせて設定する。
- メールボックスのディレクトリやuid/gidは、今後の工程で作成・調整する。



## STEP３:Postfixのバーチャルメールボックス設定確認

## 意味・目的
Postfix（メール配送サーバー）がバーチャルユーザーのメールを正しく受け取り、保存できるようにするための設定を行う。

---

## 1. `/etc/postfix/main.cf` の編集

下記の項目を追加・確認します。

```conf
# バーチャルドメイン用の設定
virtual_mailbox_domains = example.com

# バーチャルユーザーのメールボックス定義ファイル
virtual_mailbox_maps = hash:/etc/postfix/vmailbox

# バーチャルメールボックスの保存場所
virtual_mailbox_base = /var/mail/vmail

# バーチャルユーザーのUID/GID（後でvmailユーザーを作成）
virtual_uid_maps = static:5000
virtual_gid_maps = static:5000

# バーチャルエイリアス（必要に応じて）
# virtual_alias_maps = hash:/etc/postfix/virtual

# バーチャルメールボックスユーザー用メール配送
home_mailbox = Maildir/
```

- `virtual_mailbox_domains` … 運用したいメールドメイン（例：example.com）
- `virtual_mailbox_maps` … メールアドレスとメールボックスの紐付けファイル
- `virtual_mailbox_base` … メールの保存先ディレクトリ

---

## 2. `/etc/postfix/vmailbox` の作成・編集

バーチャルユーザーのメールアドレスと保存先を定義します。

```
user1@example.com    example.com/user1/
user2@example.com    example.com/user2/
```

---

### ファイルのハッシュ化（Postfix用）

```bash
sudo postmap /etc/postfix/vmailbox
```

---

## 3. バーチャルメールボックス用ディレクトリとvmailユーザーの作成

### vmailユーザー作成（UID/GIDは上記で指定した値に合わせる）

```bash
sudo useradd -r -u 5000 -g 5000 -d /var/mail/vmail -s /sbin/nologin vmail
sudo mkdir -p /var/mail/vmail
sudo chown vmail:vmail /var/mail/vmail
```

----

#### **Point**

vimboxファイルできちんとユーザーごとにメールの受信・送信済みメールが入る場所を設定しよう

```
#vimboxファイルへ入る
sudo vim /etc/postfix/vmailbox

#vimboxファイルの設定
user1@example.com   example.com/user1/Maildir/
user2@example.com   example.com/user2/Maildir/
```

---



## 4. Postfixの設定再読み込み/再起動

```bash
sudo systemctl reload postfix
# または
sudo systemctl restart postfix
```

---

## 補足
- `/etc/postfix/main.cf`の各項目はシステムに合わせて調整する。
- `/etc/postfix/vmailbox`はユーザーごとに記載する。
- `Maildir/`形式で運用する場合は、各ユーザーのディレクトリにMaildirを作成する必要あり（次工程で案内）。



## STEP 3: テストユーザーでDovecot認証動作確認

1. コマンドラインからテストユーザーで認証できるか確認します。

```bash
dovecot auth test user1@example.com password
```
※`password` は user1@example.com の実際のパスワードに置き換えてください。

2. 成功の場合は「passdb: user found」「auth succeeded」などの表示が出ます。

3. 失敗する場合は Dovecot のログ `/var/log/maillog` を確認し、設定やパスワード、userdb情報を見直します。

---

#### 補足
- Dovecotのバージョンによっては `dovecot auth test` コマンドが利用できない場合があります。その場合は `telnet` や `openssl s_client` でIMAPポートに接続し、手動でログインテストを行ってください。

## Step 4: テストメールの送信とMaildir/newの確認

```bash
echo "Test message after vmailbox fix" | mail -s "CLI test 3" user1@example.com
sudo ls -l /var/mail/vmail/example.com/user1/Maildir/new
```
- テストメール送信後、Maildir/newディレクトリに新しいメールファイルが作成されているか確認します。

