## メールサーバー構築（DNS編）



### DNSレコードの詳細（A, MX, CNAME, TXT）

DNS（Domain Name System）は、ドメイン名とIPアドレスなどを関連付ける仕組み。
ここでは、主に使われる4種類のDNSレコード（A, MX, CNAME, TXT）について詳細をまとめる。

---

### 1. Aレコード（Address Record）

**概要:**  
Aレコードは、ドメイン名をIPv4アドレスに紐付けるためのレコード。  
Webサイトやメールサーバなどの「アクセス先」を指定する際に使う。

**主な用途:**  

- example.jp → 203.0.113.1 のように変換　（ドメイン名 から IPアドレスに変換している）
- WebサーバのIPアドレス指定

---

### 2. MXレコード（Mail Exchanger Record）

**概要:**  
MXレコードは、メールサーバ（MTA）の宛先を指定するレコードです。 
これは、ドメインメールがどこに向かえば良いのかということについて指定している。
入力値としてはホスト名を入力する（メールを「どこで受け取るのか」を示さなくてはならないので）
→ だからまずAレコードの設定したのか....（**逆に、ここでAレコードの記述が間違っていると正しく「名前解決」できない。**）

**＊ここで入力するホスト名は（Aレコード）に登録してある必要がある**
＊もしメールサーバー名とホスト名が異なる場合にCNAMEで繋ぐ必要がある

メールの配送順序（優先度）も指定できる。数字が小さいほど優先度が上がり、0からスタートする

---

**Point**

```
nslookup -type=MX xxxx.jp
```

でメールサーバーとIPアドレスが表示される。

通常、DNS設定は「TTL」といって設定変更を行ってから、変更が完全に反映されるまでタイムラグが発生する（キャッシュのため）

変更したDNS設定が反映されているのかを確認する際にとても便利なのです。

ちなみに、type は MX以外にも、NS（ネームサーバ）などがある。

裏技として、このようなものもある。

```
nslookup -type=MX xxxx.jp　8.8.8.8
```

「 8.8.8.8」はGoogle Public DNSサーバーのことを示し、

Google Public DNSサーバーから対象のドメインのメールサーバー情報をのぞきたいときにめちゃくちゃ便利に使える。

特に、グローバルipアドレスととローカルipアドレスが複雑に絡み合っているとき、それを整理するのに重宝する。

＊ 8.8.8.8 はグローバルからの見え方を表してくれる。デフォルトはローカル。

---

### 3. CNAMEレコード（Canonical Name Record）

**概要:**  
CNAMEレコードは、あるドメイン名を別のドメイン名の「別名（エイリアス）」として扱うためのレコードです。  
A/AAAAレコードの参照先にリダイレクトします。

**主な用途:**  
- www.example.jp → example.jp 本体に転送
- サービスごとのサブドメイン管理

---

### 4. TXTレコード（Text Record）

**概要:**  
TXTレコードは、ドメインに関するテキスト情報を格納するためのレコード。  
SPFやDKIM、Googleサーチコンソール認証など、様々な用途に利用される。

**主な用途:**  

- メール送信認証（SPF, DKIM）

---

##### **point**

Google, microsoft が提供しているメールサービスでは基本的にSPFの設定がデフォルトになっている。
SPFとはSender Policy Frameworkの略で、迷惑メールやなりすましメールを防ぐためのメールドメイン認証システムのこと。
メールの送信元IPアドレスが、DNSに登録された正規のIPアドレスと一致するかを確認することで、メールが詐称されていないかを判定する。

#### 1. SPFレコードの登録（送信側）

送信するドメインのDNSサーバーに、  「このドメインからメール送信を許可するサーバーのIPアドレス」を記述した  
**SPFレコード（TXTレコード）**を登録する。以下のテキストを入力することでSPFの設定を行うことができる。

```
v=spf1 ip4:203.0.113.1（設定するipアドレス） ~all
```

#### 2. DNSでの問い合わせ（受信側）

メール受信サーバーはメールを受信した際、  送信元ドメインのDNSにSPFレコードが存在するかを問い合わせる。

#### 3. 送信元IPアドレスの検証（受信側）

受信サーバーは、メール送信元サーバーのIPアドレスが  SPFレコードに記載されているIPアドレス（や許可範囲）と一致するか検証。

#### 4. 判定結果による処理（受信側）

一致する場合、正規の送信元とみなし、通常通りメールを受信する。
一致しない場合はSPFレコードで許可されていない送信元と判断し、  「なりすましメール」として受信拒否、迷惑メール扱いなどの処理を行う。（当然、未設定の場合は許可されていない送信元と判断されてブロックされるよ🥺）

**＊FW設定で外部から内側への侵入するためのipアドレスと内部から外部に向かうipアドレスが違う場合があるから注意してね…**
**＊正しい値を入力してもメールの送信ができない場合は、FWの設定を見直そう**

---

- ドメイン所有権の証明

- サービス連携や認証情報の配置
