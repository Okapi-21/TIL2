## ブックマーク機能の追加

#### 実装手順

- ER図（概念同士の関連性）
  - Userテーブルとbookmarkテーブルは多対多の関係性にあるため、中間テーブルを設計する必要がある
- モデル
  - bookmarkモデルをつくり、各モデル間でのアソシエーションを整理する
  - 



#### DB設定（中間テーブル・モデル）

マイグレーションファイル

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('bookmarks', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->constrained('users')->onDelete('cascade');
            $table->foreignId('board_id')->constrained('boards')->onDelete('cascade');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('bookmarks');
    }
};
```

モデル

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Bookmark extends Model
{
    use HasFactory;

    protected $fillable = [
        'user_id',
        'board_id',
    ];

    public function user()
    {
        return $this -> belongsTo(User::class);
    }

    public function board()
    {
        return $this->belongsTo(Board::class);
    }
}

```

#### route定義

ブックマーク登録・解除のみで良いので、storeとdestroyに限定する

```php
    Route::resource('bookmarks', BookmarkController::class)->only(['store', 'destroy']);
```

#### controller定義

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Board;

class BoardController extends Controller
{
    public function index()
    {
        $boards = Board::all();
        return view('boards.index', compact('boards'));
    }

    public function create()
    {
        return view('boards.create');
    }

    public function store(Request $request)
    {
        $validatedData = $request->validate([
            'title' => 'required|max:255',
            'description' => 'required|max:65535',
        ]);

        $board = new Board();
        $board->title = $validatedData['title'];
        $board->description = $validatedData['description'];
        $board->user_id = auth()->id();

        if ($request->hasFile('board_image')){
            $filename = $request->file('board_image')->store('public/images');
            $board->image = basename($filename);
        }

        if($board->save()){
           return redirect()->route('boards.index')->with('success', '掲示板を作成しました。'); 
        }
    }

    public function show(Board $board)
    {
        return view('boards.show', compact('board'));
    }

    public function edit(Board $board)
    {
        if (auth()->id() != $board->user_id){
            return redirect()->route('boards.index')->with('error', '他のユーザーの掲示板は編集できません。');
        }

        return view('boards.edit', compact('board'));
    }

    public function update(Request $request, Board $board)
    {
        if (auth()->id() != $board->user_id){
            return redirect() -> route('boards.index')->with('error', '他のユーザー掲示板は編集できません。');
        }

        $validatedData = $request->validate([
            'title' => 'required|max:255',
            'description' => 'required|max:65535',
        ]);

        $board->fill($validatedData);

        if($request->hasFile('board_image')){
            $filename  = $request->file('board_image')->store('public/image');
            $board->image = basename($filename);
        }

        if ($board->save()) {
            return redirect() -> route('boards.show', $board)->with('success', '掲示板を更新しました。');
        }
    }

    public function destroy(Board $board)
    {
        if ( auth()->id() !== $board->user_id) {
            return redirect()->route('boards.index')->with('error', '他のユーザーの掲示板は削除できません。');
        }

        $board->delete();
        return redirect()->route('boards.index')->with('success', '掲示板を削除しました。');
    }
}

```



#### view

Boardsフォルダにparticalsというフォルダ生成後、bookmark_button.blade.phpを生成

```php+HTML
@if ($board->bookmarks->where('user_id', Auth::user()->id)->isEmpty())
    <form method="POST" action="{{ route('bookmarks.store', $board->id) }}" class="bookmark-form">
        @csrf
        <input type="hidden" name="board_id" value="{{ $board->id }}">
        <button type="submit" dusk="bookmark-button">
            <i class="ri-heart-3-line text-2xl"></i>
        </button>
    </form>
@else
    <div class="bookmark-form">
        <form method="POST" action="{{ route('bookmarks.destroy', $board->bookmarks->firstWhere('user_id', Auth::user()->id)->id) }}" class="bookmark-form">
            @method('DELETE')
            @csrf
            <button type="submit" id="js-unbookmark-{{$board->id}}" dusk="unbookmark-button">
                <i class="ri-heart-3-fill text-2xl text-rose-500"></i>
            </button>
        </form>
    </div>
@endif
```

　Index.balade.php, show.blade.phpに記してある、記事の編集・削除のための条件文を利用し、ログインユーザーの作成物でなければ、ブックマークの登録が可能になるようにする。

```php+HTML
@if (Auth::id() === $board->user_id)
           ~掲示板の編集・削除処理~
@else
    @include('boards.partials.bookmark_button')
@endif
```



> #### 補足　ルート設計とフォーム設計
>
> #### ルート設計の特徴
>
> ルート設計とは、WebアプリケーションのURL構造や、どのURLでどのコントローラー・メソッドが呼ばれるかを決めることです。Laravelでは`routes/web.php`などでルートを定義します。ルート設計の特徴は、URL自体に意味を持たせることで、リソース（データ）の階層や関係性を明確に表現できる点です。例えば、`/boards/{board}/comments`のように、掲示板(board)ごとのコメント(comment)を扱う場合、URLに`{board}`というパラメータを含めることで、どの掲示板に対する操作かを明示できます。ルートパラメータはRESTfulな設計に適しており、URLから直接値を取得できるため、コントローラーでは`$request->route('board')`のように値を受け取ります。ルート設計は、APIやリソース指向の設計で特に重要です。
>
> ------
>
> #### フォーム設定の特徴
>
> フォーム設定は、ユーザーがWebページ上でデータを入力し、サーバーに送信する仕組みを設計することです。HTMLフォームでは、`<input>`や`<select>`などの要素を使い、`name`属性で送信するデータのキーを指定します。フォーム送信時、POSTやPUTなどのHTTPメソッドでデータがサーバーに送られ、Laravelでは`$request->input('name')`で値を受け取ります。フォーム設定の特徴は、URLに依存せず、hiddenフィールドや複数の値を柔軟に送信できる点です。例えば、`<input type="hidden" name="board_id" value="123">`のように、URLに含めない値も送信できます。フォームはユーザー操作に応じて動的に値を送ることができ、バリデーションやCSRF対策も組み込めます。
>
> ------
>
> #### 違い
>
> ルート設計は「URL自体に意味を持たせ、リソースの関係性を明示する」ことが特徴で、RESTfulなAPIやリソース指向の設計に向いています。一方、フォーム設定は「ユーザーが入力した値や、URLに含めないデータも柔軟に送信できる」ことが特徴です。ルートパラメータはURLから直接値を取得しますが、フォーム値はPOSTデータとして送信されます。どちらを使うかは、設計の目的やデータの流れによって決まります。URLで明示したい場合はルート設計、ユーザー操作や非表示データを送信したい場合はフォーム設定が適しています。
