## マイグレーション

#### マイグレーションコマンド

初期化してマイグレーション反映

```
docker compose exec app php artisan migrate:reset
docker compose exec app php artisan migrate
```

DBに反映されていないマイグレーションファイルを一括適用

```
docker compose exec app php artisan migrate
```

DBに反映されているものを一つロールバック

```
 docker compose exec app php artisan migrate:rollback --step=1
```

DBに反映されているものを一括でロールバック

```
docker compose exec app php artisan migrate:reset
```

マイグレーションの適応状況を確認

```
docker compose exec app php artisan migrate:status
```

テスト環境に反映させたい時には以下のコマンドを使用する

```
docker compose exec app php artisan migrate:status --env=testing
docker compose exec app php artisan migrate --env=testing
docker compose exec app php artisan migrate:rollback --env=testing
```

マイグレーションファイルを作成する際には、以下のコマンドをターミナルで実行する

```
docker compose exec app php artisan make:migration xxxxx_xxxxx_xxxxx    
（xxxxx_xxxxx_xxxxxにマイグレーション名を入力する）
```



#### 効率的なマイグレーションファイル・モデル・ファクトリー生成 コマンド

```
docker compose exec app php artisan make:model xxxx -mfs
```

##### -m オプション
- **マイグレーションファイル**を作成
- データベーステーブルの構造を定義し、後でテーブルを作成できます

##### -f オプション
- **Factoryクラス**を作成
- テストや開発時に大量のダミーデータを自動生成できます

##### -s オプション
- **Seederクラス**を作成
- 初期データを簡単にデータベースに挿入できます



モデルやDBのデータ型を確認したい時

```
docker compose exec app php artisan tinker
```

```
\Schema::getColumnListing("xxxx");
```



#### 主なデータ型一覧（データベース）

| データ型                | 用途・説明                                  | 例（マイグレーション記法）                     | 備考・代表的な用途            |
| ----------------------- | ------------------------------------------- | ---------------------------------------------- | ----------------------------- |
| string                  | 短いテキスト（最大255文字）                 | `$table->string('name');`                      | 名前、メールアドレスなど      |
| text                    | 長いテキスト                                | `$table->text('description');`                 | 記事本文、商品説明など        |
| integer                 | 整数値                                      | `$table->integer('quantity');`                 | 数量、年齢など                |
| float                   | 小数点を含む数値                            | `$table->float('price');`                      | 金額、重量など                |
| date                    | 日付                                        | `$table->date('published_at');`                | 誕生日、締切日など            |
| boolean                 | 真偽値（true/false）                        | `$table->boolean('is_active');`                | 公開状態、有効/無効フラグなど |
| foreignId + constrained | 外部キー（簡略記法:他テーブルのIDと紐付け） | `$table->foreignId('user_id')->constrained();` | usersテーブルのidと関連付け   |

---

> **補足**  
> - データベースによって対応する型の仕様が異なることがあります。  
> - `foreignId('user_id')->constrained()`は、`user_id`カラム（unsignedBigInteger型）を作成し、`users`テーブルの`id`カラムへの外部キー制約を自動追加します。  
> - 必要に応じて`constrained('テーブル名')`で参照先テーブルを変更できます。

#### 主なカラム修飾子一覧（データベース）

| 修飾子   | 用途・説明                                                   | 例（マイグレーション記法）                         | 備考・代表的な用途                 |
| -------- | ------------------------------------------------------------ | -------------------------------------------------- | ---------------------------------- |
| default  | デフォルト値を設定。値未指定時に自動的にこの値が入る。       | `$table->boolean('is_published')->default(false);` | 公開フラグ・初期値の設定           |
| nullable | null（値なし）を許容する。                                   | `$table->text('description')->nullable();`         | 未入力可能なカラム、オプション項目 |
| index    | カラムにインデックスを付与し検索/ソート性能を向上させる。    | `$table->string('username')->index();`             | ユーザー名・頻繁に検索するカラム   |
| unique   | カラムの値が重複しないよう制約を付与する。                   | `$table->string('email')->unique();`               | メールアドレス・ユーザーIDなど     |
| unsigned | 数値型カラムで負の値を禁止する。                             | `$table->integer('age')->unsigned();`              | 年齢・ポイント・IDなど             |
| comment  | カラムに説明を付与し、テーブル設計のドキュメント化に役立てる。 | `$table->string('name')->comment('ユーザー名');`   | 設計意図や注意事項のメモ           |
| after    | カラム追加時、どのカラムの後ろに配置するかを指定する。       | `$table->string('nickname')->after('name');`       | テーブル構造を見やすく保つ         |

---

## 初学者向け補足

- **unique** … データの重複を防ぐために便利です。例えば、ユーザー登録時のメールアドレスなど。
- **unsigned** … 0以上の値しか入らない場合に使います（年齢やIDなど、マイナスが不要な場合）。
- **comment** … テーブル設計の意図や注意点を残せるので、チーム開発や将来の自分のために役立ちます。
- **after** … カラム追加時に順番を整理でき、テーブル構造が分かりやすくなります。

> カラム修飾子は、テーブル作成や変更時にカラムの性質・制約を細かく設定するために使います。<br>
> 適切に設定することで、データの整合性確保やパフォーマンス向上につながります。

---
## さらに学びたい方へ

- [Laravel公式マイグレーションドキュメント](https://laravel.com/docs/migrations)
- [RDB設計の基礎（外部サイト）](https://www.dbonline.jp/sqlite/table/index4.html)



### テーブル作成時のマイグレーションファイルの記述

```php
 public function up()
    {
        Schema::create('articles', function (Blueprint $table) {
            $table->id();
            $table->string('title')->default('記事のタイトル');
            $table->text('body')->nullable(true);
            $table->timestamps();
        });
    }
 public function down()
    {
         Schema::dropIfExists('articles');
    }
```

### カラム追加時のマイグレーションファイルの記述

```php
public function up()
    {
        Schema::table('articles', function (Blueprint $table) {
            $table->integer('price')->nullable(true);
        });
    }
public function down()
    {
        Schema::table('articles', function (Blueprint $table) {
            $table->dropColumn('price');
        });
    }

```



#### コメント

　DBに新しい属性、カラムを追加したいときには以下の手順を辿る

1. マイグレーションファイルの作成
2. マイグレーションの実行
3. マイグレーションステータスの確認
4. モデル部でカラムの編集や操作を許可する
   protected $fillable = ['カラム名']
5. ビューへDBを渡す
