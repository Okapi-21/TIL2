### カレンダー機能の実装

------

#### 要件

- ヘッダーメニューよりカレンダー画面に遷移することができる
- カレンダーには一月の間に投稿されてきたものが日別で表示される
- カレンダーは月毎に表示され、「去年」「先月」「今月」「来月」「来年」という四つのボタンがあり、ボタンを押すと機能が現在表示されている画面の時間基準でその時間にジャンプ
- リンクをクリックすることでその投稿に飛ぶことができる



#### 実装手順

**point**

> [!TIP]
>
> 今回は投稿データをカレンダーの日付に対応させて表示させているだけなので、DB・モデルは触らなくて良い。
>
> つまり、画面遷移が可能になるように「controller」「web.route」「resources/calendar/index.blade.php」のみ変更・追加を行えばよい、ということになる。



1. ##### web.routeの追加

   読み込み要素の追加を行う
   ```php
   use App\Http\Controllers\CalendarController;
   ```

   画面遷移ができるように以下の記述を追加する

   ```php
   //認証を通ったあとに
       Route::get('/calendar', [CalendarController::class, 'index'])->name('calendar.index');
   ```

   

2. ##### CalendarController.phpの作成

   以下のように記述する

   ```php
   <?php
   
   namespace App\Http\Controllers;
   use App\Models\Board;
   use Illuminate\Http\Request;
   
   class CalendarController extends Controller
   {
       public function index()
       {
           $boards = Board::all(); //掲示板全件取得
   
           $events = [];　//連想配列の作成
   
           //ループ処理
           foreach ($boards as $board) {
               $date = $board->created_at->format('Y-m-d'); //boardの日付を抜き取り、format変換
               $events[$date][] = $board;　//日付ごとに分類し、その中に投稿を入れ込んで行く
           }
   
           $name = auth()->user() ? auth()->user()->name : '';
   
           return view('calendar.index', compact('events', 'name'));
       }
   }
   ```

   > [!IMPORTANT]
   >
   > boardをカレンダーで日毎に表示するために連想配列を用いている。
   >
   > 日付を「キー」としたいので、まずはboardからcreated_atの情報を抜き取り、整形。
   >
   > その次に、日付ごとにboardを分類した連想配列にboardを入れ込んでいく。

3. ##### resources/views/layouts/navigation.blade.phpの編集

   ヘッダーから遷移することができるように以下のように編集します。
   ```html
   <div class="hidden space-x-8 sm:-my-px sm:ms-10 sm:flex">
       <x-nav-link :href="route('calendar.index')">
               カレンダー
       </x-nav-link>
   </div>
   ```

4. ##### resources/views/calendar/index.blade.phpの作成

   カレンダー表示のため、以下のようなファイルを作成します。
   （整形のしようはあると思いますが、とりあえずはこんな感じになってしまいました....）

   ```html
   <x-app-layout>
       @section('title', $name )
       <div class="container mx-auto p-4">
           
           @php
               $today = \Carbon\Carbon::today();
               $currentMonth = request('month') ? \Carbon\Carbon::parse(request('month')) : \Carbon\Carbon::now();
               $daysInMonth = $currentMonth->daysInMonth;
               $startOfMonth = $currentMonth->copy()->startOfMonth();
               $endOfMonth = $currentMonth->copy()->endOfMonth();
               $startDayOfWeek = $startOfMonth->dayOfWeek; // 0 (日曜) から 6 (土曜)
               $totalCells = 35; // 7日 × 5週（必要なら42に）
               $remainingCells = $totalCells - $startDayOfWeek - $daysInMonth + 1;
           @endphp
   
           <!-- カレンダーヘッダー -->
           <div class="flex justify-center items-center space-x-10 mb-6">
               <a href="{{ route('calendar.index', ['month' => $currentMonth->copy()->subMonth()->format('Y-m')]) }}" 
                  class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded shadow">
                   &larr; 前月
               </a>
               <h2 class="text-xl font-bold">{{ $currentMonth->format('Y年n月') }}</h2>
               <a href="{{ route('calendar.index', ['month' => $currentMonth->copy()->addMonth()->format('Y-m')]) }}" 
                  class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded shadow">
                   翌月 &rarr;
               </a>
           </div>
   
           <!-- カレンダー本体 -->
           <div class="bg-white rounded-lg shadow overflow-hidden max-w-6xl mx-auto w-full">
               <table class="w-full table-fixed" style="table-layout: fixed; width:100%;">
                   <colgroup>
                       <col style="width:14.2857%">
                       <col style="width:14.2857%">
                       <col style="width:14.2857%">
                       <col style="width:14.2857%">
                       <col style="width:14.2857%">
                       <col style="width:14.2857%">
                       <col style="width:14.2857%">
                   </colgroup>
                   <thead>
                       <tr>
                           @foreach(['日', '月', '火', '水', '木', '金', '土'] as $index => $dayName)
                               <th class="border bg-gray-50 py-2 text-center font-semibold
                                   {{ $index === 0 ? 'text-red-500' : ($index === 6 ? 'text-blue-500' : '') }}">
                                   {{ $dayName }}
                               </th>
                           @endforeach
                       </tr>
                   </thead>
                   <tbody>
                       @php $cellCount = 0; @endphp
                       <tr>
                           {{-- 前月の空白セル --}}
                           @for ($i = 0; $i < $startDayOfWeek; $i++)
                               <td class="border bg-gray-50 p-3 min-h-[160px] align-top overflow-hidden"></td>
                               @php $cellCount++; @endphp
                           @endfor
   
                           {{-- 当月の日付 --}}
                           @for ($day = 1; $day <= $daysInMonth; $day++)
                               @php
                                   $date = $currentMonth->copy()->day($day);
                                   $isToday = $date->isSameDay($today);
                                   $dayOfWeek = $date->dayOfWeek;
                                   $isWeekend = ($dayOfWeek == 0 || $dayOfWeek == 6);
                               @endphp
                               <td class="border p-3 min-h-[160px] align-top overflow-hidden
                                   {{ $isToday ? 'bg-blue-50 border-blue-300' : '' }}
                                   {{ $isWeekend ? ($dayOfWeek == 0 ? 'text-red-600' : 'text-blue-600') : '' }}">
                                   <div class="flex justify-between mb-1">
                                       <span class="{{ $isToday ? 'font-bold' : '' }}">{{ $day }}</span>
                                   </div>
                                   <div class="space-y-1">
                                       @if(isset($events[$date->format('Y-m-d')]))
                                           @foreach($events[$date->format('Y-m-d')] as $board)
                                               <a href="/boards?date={{ $date->format('Y-m-d') }}#post-{{ $board->id }}"
                                                  class="block text-sm p-2 bg-green-100 text-green-800 rounded hover:bg-green-200 transition w-full overflow-hidden"
                                                  style="display:block; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">
                                                   {{ \Illuminate\Support\Str::limit(strip_tags($board->description), 40) }}
                                               </a>
                                           @endforeach
                                       @endif
                                   </div>
                               </td>
                               @php
                                   $cellCount++;
                                   if ($cellCount % 7 == 0 && $day != $daysInMonth) echo '</tr><tr>';
                               @endphp
                           @endfor
   
                           {{-- 翌月の空白セル --}}
                           @for ($i = 0; $cellCount % 7 != 0; $i++)
                               <td class="border bg-gray-50 p-3 min-h-[160px] align-top overflow-hidden"></td>
                               @php $cellCount++; @endphp
                           @endfor
                       </tr>
                   </tbody>
               </table>
           </div>
       </div>
   </x-app-layout>
   ```

   以下、解説コード全体の解説

   

   このコードは、LaravelのBladeテンプレートで作成された「カレンダー表示画面」です。月ごとに日付を並べて、日付ごとにイベント（予定や投稿など）を表示する仕組みです。HTML・CSSとPHP（Blade構文）が混ざっているので、１行ずつ、できるだけやさしく説明します。

   ---

   ## 1行ずつ解説

   ```blade
   <x-app-layout>
   ```
   **「x-app-layout」**  
   Laravelで使うレイアウトの部品（コンポーネント）。画面全体の枠や共通部分（ヘッダー・フッターなど）をまとめるために使う。

   ---

   ```blade
       @section('title', $name )
   ```
   **「@section('title', $name )」**  
   ページのタイトルを設定している。`$name`はコントローラーから渡ってきたページ名。

   ---

   ```blade
       <div class="container mx-auto p-4">
   ```
   **「div」タグ：container**  
   画面の中央にコンテンツを配置（`mx-auto`）。内側の余白（`p-4`）もつけています。

   ---

   ```blade
           @php
               $today = \Carbon\Carbon::today();
   ```
   **「@php」**  
   ここからPHPの処理を書きます。  
   `$today = \Carbon\Carbon::today();`  
   今日の日付を取得（例：2025-10-21）。Carbonは日付を扱うための便利なライブラリです。

   ---

   ```blade
               $currentMonth = request('month') ? \Carbon\Carbon::parse(request('month')) : \Carbon\Carbon::now();
   ```
   **「$currentMonth」**  
   URLの「month」パラメータがあれば、その月を取得。なければ今月。  
   例：?month=2025-10 → 2025年10月、なければ今日の月。

   ---

   ```blade
               $daysInMonth = $currentMonth->daysInMonth;
   ```
   **「$daysInMonth」**  
   今表示している月の日数（例：10月なら31）を取得。

   ---

   ```blade
               $startOfMonth = $currentMonth->copy()->startOfMonth();
   ```
   **「$startOfMonth」**  
   月の最初の日（例：2025-10-01）を取得。

   ---

   ```blade
               $endOfMonth = $currentMonth->copy()->endOfMonth();
   ```
   **「$endOfMonth」**  
   月の最後の日（例：2025-10-31）を取得。

   ---

   ```blade
               $startDayOfWeek = $startOfMonth->dayOfWeek; // 0 (日曜) から 6 (土曜)
   ```
   **「$startDayOfWeek」**  
   月の最初の日が何曜日か取得。  
   0が日曜、6が土曜。

   ---

   ```blade
               $totalCells = 35; // 7日 × 5週（必要なら42に）
   ```
   **「$totalCells」**  
   カレンダーのマス目の合計数。1週間7日×5週＝35。月によっては6週42マス必要な場合も。

   ---

   ```blade
               $remainingCells = $totalCells - $startDayOfWeek - $daysInMonth + 1;
   ```
   **「$remainingCells」**  
   月の最初の日から始めて、当月の日数を引いて、残る空白マス（翌月分）の数を計算。

   ---

   ```blade
           @endphp
   ```
   **「@endphp」**  
   PHPの処理終了。

   ---

   ```blade
           <!-- カレンダーヘッダー -->
           <div class="flex justify-center items-center space-x-10 mb-6">
   ```
   **「カレンダーヘッダー」**  
   カレンダー上部の部分（前月・今月・翌月の切り替え）を作る。

   ---

   ```blade
               <a href="{{ route('calendar.index', ['month' => $currentMonth->copy()->subMonth()->format('Y-m')]) }}" 
                  class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded shadow">
                   &larr; 前月
               </a>
   ```
   **「前月リンク」**  
   `<a>`タグで「前月」へのリンク。  
   `route('calendar.index', ['month' => ...])`でURLを生成。  
   見た目はボタン風。

   ---

   ```blade
               <h2 class="text-xl font-bold">{{ $currentMonth->format('Y年n月') }}</h2>
   ```
   **「今月の表示」**  
   今表示している月（例：2025年10月）を大きな文字で表示。

   ---

   ```blade
               <a href="{{ route('calendar.index', ['month' => $currentMonth->copy()->addMonth()->format('Y-m')]) }}" 
                  class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded shadow">
                   翌月 &rarr;
               </a>
   ```
   **「翌月リンク」**  
   「翌月」へのリンクボタン。

   ---

   ```blade
           </div>
   ```
   **ヘッダー終了**

   ---

   ```blade
           <!-- カレンダー本体 -->
           <div class="bg-white rounded-lg shadow overflow-hidden max-w-6xl mx-auto w-full">
   ```
   **「カレンダー本体」**  
   カレンダー全体を囲む枠。見た目を白背景＆角丸＆影つきに。

   ---

   ```blade
               <table class="w-full table-fixed" style="table-layout: fixed; width:100%;">
   ```
   **「table」タグ**  
   カレンダー（表）を作る。幅は100%、列の幅も固定。

   ---

   ```blade
                   <colgroup>
                       <col style="width:14.2857%">
                       ...（省略）
   ```
   **「colgroup」**  
   1週間7日なので、1列の幅を約14%ずつに設定。

   ---

   ```blade
   <thead>
       <tr>
           @foreach(['日', '月', '火', '水', '木', '金', '土'] as $index => $dayName)
               <th class="border bg-gray-50 py-2 text-center font-semibold
                   {{ $index === 0 ? 'text-red-500' : ($index === 6 ? 'text-blue-500' : '') }}">
                   {{ $dayName }}
               </th>
           @endforeach
       </tr>
   </thead>
   ```
   **「曜日の列」**  
   上に「日・月・火…」と表示。  
   日曜（$index==0）は赤色、土曜（$index==6）は青色。

   ---

   ```blade
   <tbody>
     @php $cellCount = 0; @endphp
   <tr>
   ```
   **「tbody」**  
   ここから日付のマス目を並べる。  
   `$cellCount`は表示したマス目の数。

   ---

   ```blade
   {{-- 前月の空白セル --}}
   @for ($i = 0; $i < $startDayOfWeek; $i++)
       <td class="border bg-gray-50 p-3 min-h-[160px] align-top overflow-hidden"></td>
       @php $cellCount++; @endphp
   @endfor
   ```
   **「前月の空白セル」**  
   月初が火曜なら、火曜（2番目）まで空白マスを表示。  
   例：10月1日が木曜なら、最初に3つ空白マス。

   ---

   ```blade
   {{-- 当月の日付 --}}
   @for ($day = 1; $day <= $daysInMonth; $day++)
       @php
           $date = $currentMonth->copy()->day($day);
           $isToday = $date->isSameDay($today);
           $dayOfWeek = $date->dayOfWeek;
           $isWeekend = ($dayOfWeek == 0 || $dayOfWeek == 6);
       @endphp
   ```
   **「当月の日付」**  
   1日から月末まで繰り返し表示。  
   - `$date`：その日の日付  
   - `$isToday`：今日かどうか判定  
   - `$dayOfWeek`：何曜日か  
   - `$isWeekend`：土日かどうか判定

   ---

   ```blade
   <td class="border p-3 min-h-[160px] align-top overflow-hidden
       {{ $isToday ? 'bg-blue-50 border-blue-300' : '' }}
       {{ $isWeekend ? ($dayOfWeek == 0 ? 'text-red-600' : 'text-blue-600') : '' }}">
       <div class="flex justify-between mb-1">
           <span class="{{ $isToday ? 'font-bold' : '' }}">{{ $day }}</span>
       </div>
   ```
   **「日付セルの見た目」**  
   - 今日なら背景色を変える  
   - 日曜なら赤文字、土曜なら青文字  
   - 日付（数字）を表示

   ---

   ```blade
   <div class="space-y-1">
     @if(isset($events[$date->format('Y-m-d')]))
         @foreach($events[$date->format('Y-m-d')] as $board)
             <a href="/boards?date={{ $date->format('Y-m-d') }}#post-{{ $board->id }}"
                class="block text-sm p-2 bg-green-100 text-green-800 rounded hover:bg-green-200 transition w-full overflow-hidden"
                style="display:block; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">
                 {{ \Illuminate\Support\Str::limit(strip_tags($board->description), 40) }}
             </a>
         @endforeach
     @endif
   </div>
   ```
   **「イベントの表示」**  
   その日にイベントがあれば、一覧を表示。  
   - イベント（予定や投稿）があれば、リンクで表示  
   - 内容は40文字以内に省略（長いと…になる）  
   - 投稿の詳細ページへのリンク

   ---

   ```blade
     </td>
     @php
         $cellCount++;
         if ($cellCount % 7 == 0 && $day != $daysInMonth) echo '</tr><tr>';
     @endphp
   @endfor
   ```
   **「行の調整」**  
   1週間（7マス）ごとに改行する。  
   月末以外は次の行へ。

   ---

   ```blade
                           {{-- 翌月の空白セル --}}
                           @for ($i = 0; $cellCount % 7 != 0; $i++)
                               <td class="border bg-gray-50 p-3 min-h-[160px] align-top overflow-hidden"></td>
                               @php $cellCount++; @endphp
                           @endfor
   ```
   **「翌月の空白セル」**  
   月末の後、空いているマスを空白にして調整。  
   例：月末が水曜なら、残りの木・金・土を空白マス。

   ---

   ```blade
                       </tr>
                   </tbody>
   ```
   **表の行終了（tbody）**

   ---

   ```blade
               </table>
           </div>
       </div>
   </x-app-layout>
   ```
   **テーブルや枠の終了**  
   画面全体のレイアウトの終了。





























