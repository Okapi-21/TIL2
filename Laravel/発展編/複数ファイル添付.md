

## 複数ファイル添付機能

このドキュメントは、これまでのやり取り・実際に遭遇した不具合と解決策を踏まえ、初学者でも迷わないように丁寧にまとめた実装ガイドです。  
対象バージョンの例: PHP 8.3 / Laravel 12.x

---

## 0. まず押さえる全体像（要件と流れ）

- 投稿（Board）に複数ファイル（Attachment）を添付できる
- 実ファイルは storage/app/attachments/{board_id}/UUID.拡張子 に保存（直リンク不可）
- DB の attachments テーブルにメタ情報（元名/保存パス/MIME/サイズ/投稿者）を保存
- 閲覧・ダウンロードは必ずコントローラ経由（認可チェック必須）
- 物理ファイルが無い場合は 404 を返す（親切なエラーハンドリング）
- パーミッション・環境差異・パス組み立てミスに強い実装にする

参考（BoardController 冒頭の use 文）:
```php
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use App\Http\Requests\StoreBoardRequest; // バリデーション用FormRequest
```

---

## 1. データモデル・リレーション

- Board 1件に対して Attachment 複数（1:N）

### 1.1 Migration（例）

```php
// database/migrations/xxxx_xx_xx_create_attachments_table.php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('attachments', function (Blueprint $table) {
            $table->id();
            $table->foreignId('board_id')->constrained()->cascadeOnDelete();
            $table->string('filename');   // 元ファイル名（表示用）
            $table->string('filepath');   // 保存パス（例: attachments/5/uuid.jpg）
            $table->string('mime_type')->nullable();
            $table->unsignedBigInteger('size')->default(0);
            $table->foreignId('uploaded_by')->constrained('users');
            $table->timestamps();

            $table->index(['board_id']);
            $table->index(['uploaded_by']);
        });
    }
    public function down(): void {
        Schema::dropIfExists('attachments');
    }
};
```

### 1.2 モデル

```php
// app/Models/Board.php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Board extends Model
{
    protected $fillable = ['description'];

    public function attachments() {
        return $this->hasMany(Attachment::class);
    }
}
```

```php
// app/Models/Attachment.php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Storage;

class Attachment extends Model
{
    protected $fillable = [
        'board_id', 'filename', 'filepath', 'mime_type', 'size', 'uploaded_by',
    ];

    public function board() {
        return $this->belongsTo(Board::class);
    }

    // レコード削除時に物理ファイルも削除（運用次第で導入）
    protected static function booted() {
        static::deleting(function (Attachment $attachment) {
            $disk = Storage::disk('local');
            if ($attachment->filepath && $disk->exists($attachment->filepath)) {
                $disk->delete($attachment->filepath);
            }
        });
    }
}
```

---

## 2. フォーム（複数ファイル取得）

- form に enctype を必ず付与
- input は name="files[]" かつ multiple

```blade
{{-- resources/views/boards/create.blade.php --}}
<form method="POST" action="{{ route('boards.store') }}" enctype="multipart/form-data">
    @csrf

    <textarea name="description" rows="4" required>{{ old('description') }}</textarea>
    @error('description') <p class="text-red-600">{{ $message }}</p> @enderror

    <input type="file" name="files[]" multiple>
    @error('files') <p class="text-red-600">{{ $message }}</p> @enderror
    @error('files.*') <p class="text-red-600">{{ $message }}</p> @enderror

    <button type="submit">投稿する</button>
</form>
```

---

## 3. バリデーション（FormRequest）

```php
// app/Http/Requests/StoreBoardRequest.php
namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StoreBoardRequest extends FormRequest
{
    public function authorize(): bool {
        return auth()->check();
    }

    public function rules(): array {
        return [
            'description' => ['required', 'string', 'max:2000'],
            'files'       => ['nullable', 'array', 'max:10'], // 最大10ファイルなど
            'files.*'     => [
                'file',
                'max:10240',        // 10MB (KB単位)
                'mimetypes:image/jpeg,image/png,application/pdf', // 必要に応じて
            ],
        ];
    }

    public function messages(): array {
        return [
            'files.max'   => '添付は最大10個までです。',
            'files.*.max' => '各ファイルは10MB以下にしてください。',
        ];
    }
}
```

注意:
- php.ini の `upload_max_filesize` と `post_max_size` がルールより小さいとアップロード自体が失敗します。サーバ設定も併せて確認してください。

---

## 4. コントローラ（投稿保存＋実ファイル保存）

「実ファイル保存が成功したらDBに記録」の順番が最重要。  
また Laravel 12 では `$this->middleware('auth')` をコントローラで使えません（ルート側で付与）。

```php
// app/Http/Controllers/BoardController.php
namespace App\Http\Controllers;

use App\Models\Board;
use App\Http\Requests\StoreBoardRequest;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\DB;

class BoardController extends Controller
{
    public function store(StoreBoardRequest $request)
    {
        return DB::transaction(function () use ($request) {
            // 1) Board 本体
            $board = new Board();
            $board->description = $request->input('description');
            $board->user_id = auth()->id();
            $board->save();

            // 2) 添付ファイルがあれば保存
            if ($request->hasFile('files')) {
                foreach ($request->file('files') as $uploadedFile) {
                    if (!$uploadedFile->isValid()) {
                        continue; // 不正なファイルはスキップ
                    }

                    $dir = "attachments/{$board->id}";
                    $ext = $uploadedFile->getClientOriginalExtension();
                    $storedName = Str::uuid()->toString() . ($ext ? ".{$ext}" : '');

                    // 実ファイル保存
                    $path = Storage::disk('local')->putFileAs($dir, $uploadedFile, $storedName);
                    if (!$path) {
                        // ここで例外→トランザクションにより Board もロールバック
                        throw new \RuntimeException("ファイルの保存に失敗しました: {$dir}/{$storedName}");
                    }

                    // DB へメタ情報を保存（実ファイル保存成功後に行う）
                    $board->attachments()->create([
                        'filename'    => $uploadedFile->getClientOriginalName(),
                        'filepath'    => $path, // 例: attachments/5/uuid.jpg
                        'mime_type'   => $uploadedFile->getMimeType(),
                        'size'        => $uploadedFile->getSize(),
                        'uploaded_by' => auth()->id(),
                    ]);
                }
            }

            return redirect()->route('boards.index')->with('success', '投稿を作成しました。');
        });
    }
}
```

ポイント:
- putFileAs は成功すると「相対パス（attachments/...）」を返します
- 失敗（false）を必ずチェックし、DB 保存は行わない
- ルート側で `->middleware('auth')` を付ける（後述）

---

## 5. ファイル参照・ダウンロード（認可＋Storage 経由）

authorize() を使うには AuthorizesRequests トレイトが必要。  
パスの組み立ては Storage ファサードで吸収し、存在チェックも行う。

```php
// app/Http/Controllers/AttachmentController.php
namespace App\Http\Controllers;

use App\Models\Attachment;
use Illuminate\Support\Facades\Storage;
use \Illuminate\Foundation\Auth\Access\AuthorizesRequests;

class AttachmentController extends Controller
{
    use AuthorizesRequests;

    // ブラウザ内で表示（画像, PDFなど）
    public function show(Attachment $attachment)
    {
        $this->authorize('view', $attachment);

        $disk = Storage::disk('local');
        if (!$disk->exists($attachment->filepath)) {
            abort(404, 'File not found');
        }

        $absolutePath = $disk->path($attachment->filepath);
        $headers = [
            'Content-Type'        => $attachment->mime_type ?: 'application/octet-stream',
            'Content-Disposition' => 'inline; filename="' . $attachment->filename . '"',
        ];
        return response()->file($absolutePath, $headers);
    }

    // 強制ダウンロード
    public function download(Attachment $attachment)
    {
        $this->authorize('download', $attachment);

        $disk = Storage::disk('local');
        if (!$disk->exists($attachment->filepath)) {
            abort(404, 'File not found');
        }

        return response()->download(
            $disk->path($attachment->filepath),
            $attachment->filename,
            ['Content-Type' => $attachment->mime_type ?: 'application/octet-stream']
        );
    }
}
```

---

## 6. 認可（Policy）と登録

### 6.1 Policy の例

```php
// app/Policies/AttachmentPolicy.php
namespace App\Policies;

use App\Models\Attachment;
use App\Models\User;

class AttachmentPolicy
{
    public function view(User $user, Attachment $attachment): bool
    {
        return $user->id === $attachment->board->user_id
            || $user->id === $attachment->uploaded_by
            || ($user->is_admin ?? false); // 無ければ削除
    }

    public function download(User $user, Attachment $attachment): bool
    {
        return $this->view($user, $attachment);
    }
}
```

### 6.2 AuthServiceProvider での紐付け

```php
// app/Providers/AuthServiceProvider.php
namespace App\Providers;

use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider;
use App\Models\Attachment;
use App\Policies\AttachmentPolicy;

class AuthServiceProvider extends ServiceProvider
{
    protected $policies = [
        Attachment::class => AttachmentPolicy::class,
    ];

    public function boot(): void
    {
        //
    }
}
```

---

## 7. ルーティング（Laravel 12 の注意事項）

- Laravel 12 ではコントローラの `$this->middleware('auth')` は非推奨/廃止
- ルート側でミドルウェアを付与する

```php
// routes/web.php
use App\Http\Controllers\AttachmentController;
use App\Http\Controllers\BoardController;

Route::middleware('auth')->group(function () {
    Route::get('/boards/create', [BoardController::class, 'create'])->name('boards.create');
    Route::post('/boards', [BoardController::class, 'store'])->name('boards.store');

    Route::get('/attachments/{attachment}', [AttachmentController::class, 'show'])->name('attachments.show');
    Route::get('/attachments/{attachment}/download', [AttachmentController::class, 'download'])->name('attachments.download');
});

Route::get('/boards', [BoardController::class, 'index'])->name('boards.index');
```

---

## 8. ビュー表示（一覧・プレビュー・DL）

```blade
{{-- 例: resources/views/boards/show.blade.php （または index の各行） --}}
<ul>
@foreach($board->attachments as $file)
    <li>
        <a href="{{ route('attachments.show', $file) }}" target="_blank">{{ $file->filename }}</a>
        |
        <a href="{{ route('attachments.download', $file) }}">ダウンロード</a>

        {{-- 画像ならプレビュー --}}
        @if(Str::startsWith($file->mime_type, 'image/'))
            <div>
                <img src="{{ route('attachments.show', $file) }}" alt="{{ $file->filename }}" width="240">
            </div>
        @endif
    </li>
@endforeach
</ul>
```

補足:
- Blade で `Str::startsWith` を使うには `use Illuminate\Support\Str;` がどこかでロードされている必要があります（Laravel では `Str` がクラスエイリアスとして利用できることが多いです。もし未解決なら `\Illuminate\Support\Str::startsWith(...)` とフルパスで記述）

---

## 9. ストレージ設定・パーミッション・運用

### 9.1 .env 例
```
FILESYSTEM_DISK=local
APP_ENV=production
APP_DEBUG=false
```

- 今回は private なローカルストレージ（local）を使用（public ではない）
- S3 等に将来移行する場合も、Storage ファサード経由だと差し替えが容易

### 9.2 パーミッション（Linux の例）
Web サーバユーザ（apache/www-data 等）に書き込み権限を付与

```bash
sudo chown -R apache:apache /var/www/laravel-app/storage
sudo chmod -R 775 /var/www/laravel-app/storage
```

- storage/app/attachments/ 以下は保存時に自動作成されますが、親ディレクトリの書き込み権限が必要
- デプロイ・移行時は storage/app を必ず一緒に同期する（DB だけコピーすると「パスはあるが実体がない」事故に）

---

## 10. トラブル事例と対処（今回実際に遭遇したもの）

- エラー: Call to undefined method Controller::middleware()  
  → Laravel 12 で廃止。ルーティングで middleware を指定する

- エラー: Call to undefined method Controller::authorize()  
  → コントローラで `use Illuminate\Foundation\Auth\Access\AuthorizesRequests;` を追加し、`use AuthorizesRequests;` を宣言

- エラー: FileNotFoundException（ファイルが無い）  
  → DB の filepath はあるが物理ファイルが無い。原因は以下が多い
  - 書き込み権限不足で保存に失敗していた（例: storage が apache 権限でない）
  - パス組み立てミス（storage_path 直書きではなく Storage::disk()->path を使う）
  - 移行時に storage を持って来ていない
  → 解決: Storage 経由で exists/path を使い、なければ 404。保存失敗時は DB 保存しない。

- エラー: attachments ディレクトリが存在しない  
  → 保存が1度も成功していないか、権限不足。権限修正と新規アップロードの動作確認

---

## 11. セキュリティと品質（ベストプラクティス）

- 保存名は UUID を使い、推測困難に（元名はDB表示用のみに）
- バリデーションで MIME・サイズ・拡張子を制限
- 認可（Policy）で対象ユーザのみ閲覧・ダウンロードを許可
- ストレージは直リンク不可な storage/app を利用し、必ずコントローラ経由で配信
- エラーハンドリング（ファイル不存在時は 404）とログ出力
- 大容量・多数ファイル時はジョブ/キューの検討、サムネイル生成などは非同期化
- S3 など外部ストレージに移行しやすいよう Storage 経由に統一

---

## 12. メンテナンスと運用

- 「DB にはあるが実ファイルが無い」孤児データの定期検出
  - スクリプトで attachments を走査し、`Storage::exists($filepath)` が false のレコードをレポート/削除
- Board/Attachment の削除時に物理ファイルも削除（モデルイベントで対応例を記載済み）
- バックアップは DB と storage/app の両方を取得

---

## 13. テスト観点（例）

- 正常: 複数ファイルを添付 → storage/app/attachments/{board_id}/ にファイル作成 → DB メタ情報一致
- 異常: 保存失敗（権限/容量など）→ 例外でロールバックされ DB に記録されない
- 認可: 作成者/アップロード者以外は view/download が 403
- 存在しないファイル: 404 を返す
- 画像プレビュー: image/* のみ inline 表示、それ以外はダウンロード

---

## 14. 実ファイルと DB の整合性チェック（コマンド例）

```bash
# 物理ファイルの存在確認
sudo find storage/app/attachments -type f -name 'b27cb72a-*.jpg' -print
# 例の出力:
# storage/app/attachments/1/b27cb72a-e2ca-433a-85df-18311a300b73.jpg
```

DB の `attachments.filepath` には `attachments/1/b27cb72a-e2ca-433a-85df-18311a300b73.jpg` のような相対パスが入っていること。

---

## 15. 最後に（チェックリスト）

- [ ] フォーム: enctype, files[] multiple
- [ ] バリデーション: files, files.*（MIME/サイズ等）
- [ ] コントローラ: putFileAs 成功時のみ DB 保存。例外処理あり
- [ ] 参照/DL: Storage 経由で exists/path、認可チェック、404 ハンドリング
- [ ] Policy: view/download 実装、AuthServiceProvider に登録
- [ ] ルート: auth ミドルウェアはルート側で付与（Laravel 12）
- [ ] 権限: storage に Web サーバユーザの書き込み権限
- [ ] 運用: DB と storage のバックアップ、孤児ファイル検出、削除時の物理ファイル連動
- [ ] 監視: laravel.log のエラー監視、php.ini のサイズ制限

このガイドに沿えば、パスミス・権限不足・認可漏れなどの落とし穴を回避し、堅牢な「複数ファイル添付」機能を実装できます。





## 補足

#### BoardControllerのファイルアップロード処理 詳細解説

#### 1. use文の意味

```php
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use App\Http\Requests\StoreBoardRequest;
```

- **Storage**  
  ファイルの保存・取得などを簡単に行うためのLaravelのファサードです。  
  例：`Storage::put()`, `Storage::disk('local')->get()`
- **Str**  
  文字列操作用のヘルパークラス。`Str::uuid()`で重複しないファイル名を生成できます。
- **StoreBoardRequest**  
  フォームから送信された値のバリデーション（検証）を行うクラスです。

---

### 2. ファイルアップロード処理の流れ

```php
if ($request->hasFile('files')) {
    foreach ($request->file('files') as $uploadedFile) {
        if (!$uploadedFile->isValid()) {
            continue; // アップロード失敗ファイルはスキップ
        }
        // 保存先ディレクトリ
        $dir = "attachments/{$board->id}";
        // UUIDでファイル名生成
        $ext = $uploadedFile->getClientOriginalExtension();
        $storedName = Str::uuid()->toString() . ($ext ? ".{$ext}" : '');
        // ファイル保存（storage/app/attachments/{board_id}/xxxx.xxx）
        $path = Storage::disk('local')->putFileAs($dir, $uploadedFile, $storedName);

        // attachmentsテーブルに記録
        $board->attachments()->create([
            'filename'    => $uploadedFile->getClientOriginalName(),
            'filepath'    => $path,
            'mime_type'   => $uploadedFile->getMimeType(),
            'size'        => $uploadedFile->getSize(),
            'uploaded_by' => auth()->id(),
        ]);
    }
}
```

### 詳細解説

1. **`if ($request->hasFile('files')) { ... }`**  
   フォームから"files[]"でファイルが送信されていれば処理を開始。

2. **`foreach ($request->file('files') as $uploadedFile) { ... }`**  
   複数ファイルを一つずつ取り出して処理。

3. **`if (!$uploadedFile->isValid()) { continue; }`**  
   アップロードエラーなどの不正ファイルはスキップ。

4. **`$dir = "attachments/{$board->id}";`**  
   保存先ディレクトリ名を決定。投稿IDごとにサブフォルダを作成し管理。

5. **`$ext = $uploadedFile->getClientOriginalExtension();`**  
   元ファイルの拡張子（例：pdf, png, mdなど）を取得。

6. **`$storedName = Str::uuid()->toString() . ($ext ? ".{$ext}" : '');`**  
   ランダムなUUIDを使って重複しないファイル名を生成。

7. **`$path = Storage::disk('local')->putFileAs($dir, $uploadedFile, $storedName);`**  
   storage/app/attachments/{board_id}/配下にファイルを保存。  
   $path には「attachments/5/xxxx-uuid.pdf」等が入る。

8. **DB登録**
   ```php
   $board->attachments()->create([
       'filename'    => $uploadedFile->getClientOriginalName(),
       'filepath'    => $path,
       'mime_type'   => $uploadedFile->getMimeType(),
       'size'        => $uploadedFile->getSize(),
       'uploaded_by' => auth()->id(),
   ]);
   ```
   - 元ファイル名・保存先パス・MIMEタイプ・サイズ・アップロード者IDをattachmentsテーブルに登録。

---

### 3. まとめ

- フォームから複数ファイルを受け取り
- 1つずつ安全に「storage/app/attachments/投稿ID/」へ保存
- 保存したファイル情報をDBに記録
- 万が一アップロード失敗ファイルはスキップ

これにより、**ファイル名重複や不正アクセスを防ぎつつ、投稿ごとにファイルを安全に管理できます。**