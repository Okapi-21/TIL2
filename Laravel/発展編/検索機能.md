### 検索機能

------



#### Spatie/laravel-query-builder

　Laravelで検索やフィルタリング、並び替えなどの機能を簡単・柔軟に実装するためのcomposer（パッケージ）のこと。
通常、複数の検索条件をEloquentやクエリビルダーで組み合わせて書くと、コントローラーのコードが複雑になりがちだが、本パッケージを使用することで、検索条件の追加・管理がシンプルになる。



> [!NOTE]
>
> カレンダー機能と同様に「検索」機能に関しては新しくマイグレーション・モデルファイルを追加する必要はないが、
>
> ルートを設定して、導線を繋げたり、コントローラーで機能を定義してあげることは必要である。



#### Spaite インストール

以下コマンドを実施して、Spaiteをインストールしましょう

```
composer require spatie/laravel-query-builder
```



#### Web.route

検索画面を表示・遷移するためにrouteの設定を行う

```
use App\Http\Controllers\SearchController;
...

	// 認証後に下記を追加
	Route::get('/search',[SearchController::class, 'index'])->name('search.index');
```



#### SearchControllerの設定

以下のようにコントローラーを生成する

```
<?php

namespace App\Http\Controllers;
use Illuminate\Http\Request;
use Spatie\QueryBuilder\QueryBuilder;
use Spatie\QueryBuilder\AllowedFilter;
use App\Models\Board;

class SearchController extends Controller
{
    public function index(Request $request)
    {
        $boards = QueryBuilder::for(Board::class)
            ->allowedFilters([
                AllowedFilter::scope('user_name'), // ユーザー名での検索
                AllowedFilter::exact('status'), // ステータスは完全一致で検索
                AllowedFilter::scope('start_date'), // 開始時点
                AllowedFilter::scope('end_date'),   // 終了時点
                AllowedFilter::scope('keyword'),    // キーワード
            ])
            ->get();

        $name = auth()->user() ? auth()->user()->name : '';

        return view('search.index', compact('boards', 'name'));
    }
}
```

> [!IMPORTANT]
>
> 以下の記述を忘れないように注意しましょう
>
> ```
> use Spatie\QueryBuilder\QueryBuilder;
> ```
>
> ```
> use Spatie\QueryBuilder\AllowedFilter;
> ```
>
> QueryBuilder：LaravelでDBから情報を取得する処理（検索・フィルタリング）をより便利で安全に書くための仕組みのこと
>
> AllowedFilter：SpatieのQueryBuilderで利用される「どの項目に対してフィルタ処理を許可するか」を定義するためのクラス
> 　　　　　　
>
> 基本的にこの二つはセットで用いるので、クソ暗記でもOK



> [!IMPORTANT]
>
> 検索ロジックは以下のようになっている
> ```
> $boards = QueryBuilder::for(Board::class)
>             ->allowedFilters([
>                 AllowedFilter::scope('user_name'), // ユーザー名での検索
>                 AllowedFilter::exact('status'), // ステータスは完全一致で検索
>                 AllowedFilter::scope('start_date'), // 開始時点
>                 AllowedFilter::scope('end_date'),   // 終了時点
>                 AllowedFilter::scope('keyword'),    // キーワード
>             ])
>             ->get();
> ```
>
> 　以上のコードから「ユーザー名」「ステータス」「開始時」「終了時」「キーワード」で検索ができるようになっていることがわかる。
>
> 
>
> ・「Querybuilder::for(Board::class）」で今からBoardのDBをQueryBuilderを使用して処理することを明言
>
> ・「allowedFilters([])」で、許可要素が複数あることを明示
>
> ・ AllowedFilter::scopeでモデルにて許可・部分一致検索するカラムを明示
>
> ・AllowedFilter::exactで完全一致で検索



#### modelにScope関数の記述追加

#### Scope関数

------

**Scope関数**：DBから情報を取ってくる時の条件をまとめたもの

　　　　　　それぞれの検索条件を独立して管理することができるので、検索を複数条件で行いたいときにめちゃくちゃ便利！



以下のように記述します

```
public function scopeStartDate($query, $value)
    {
        return $query -> whereDate('created_at', '>=', $value);
    }

    public function scopeEndDate($query, $value)
    {
        return $query -> whereDate('created_at', '<=', $value);
    }

    public function scopeKeyword($query, $value)
    {
        return $query -> where( function($q) use ($value) {
            $q ->where('description', 'like', "%{$value}%");
        });
    }

    public function scopeUserName($query, $value)
    {
        return $query->whereHas('user', function ($q) use ($value) {
            $q->where('name', 'like', "%{$value}%");
        });
    }
```



#### View画面

```
<x-app-layout>
    @section('title', $name )

    <div class="py-12">
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
            <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg p-6">

                {{-- 検索フォーム（条件を横並びに） --}}
                <form method="GET" action="{{ route('search.index') }}" class="mb-6 flex flex-wrap items-end gap-4">
                    <div class="flex flex-col min-w-[180px]">
                        <label class="text-sm mb-1">開始日</label>
                        <input type="date" name="filter[start_date]" value="{{ request('filter.start_date') }}"
                               class="block w-full border-gray-300 rounded-md">
                    </div>

                    <div class="flex flex-col min-w-[180px]">
                        <label class="text-sm mb-1">終了日</label>
                        <input type="date" name="filter[end_date]" value="{{ request('filter.end_date') }}"
                               class="block w-full border-gray-300 rounded-md">
                    </div>

                    <div class="flex-1 min-w-[220px]">
                        <label class="text-sm mb-1">キーワード</label>
                        <input type="text" name="filter[keyword]" value="{{ request('filter.keyword') }}"
                               class="block w-full border-gray-300 rounded-md" placeholder="検索ワード">
                    </div>

                    <div class="flex flex-col min-w-[180px]">
                        <label class="text-sm mb-1">ユーザー名</label>
                        <input type="text" name="filter[user_name]" value="{{ request('filter.user_name') }}"
                               class="block w-full border-gray-300 rounded-md" placeholder="ユーザー名">
                    </div>

                    <div class="flex flex-col min-w-[140px]">
                        <label class="text-sm mb-1">ステータス</label>
                        <select name="filter[status]" class="block w-full border-gray-300 rounded-md">
                            <option value="">全て</option>
                            <option value="pending" {{ request('filter.status') === 'pending' ? 'selected' : '' }}>保留中</option>
                            <option value="ongoing" {{ request('filter.status') === 'ongoing' ? 'selected' : '' }}>継続中</option>
                            <option value="done" {{ request('filter.status') === 'done' ? 'selected' : '' }}>完了</option>
                        </select>
                    </div>

                    <div class="flex items-center">
                        <button type="submit" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-md">検索</button>
                    </div>
                </form>

                {{-- 結果テーブル --}}
                @if($boards->count())
                <div class="overflow-x-auto">
                    <table class="min-w-full table-fixed border-collapse divide-y divide-gray-200">
                        <colgroup>
                            <col style="width:5%"><!-- 時間 -->
                            <col style="width:13%"><!-- 投稿者 -->
                            <col style="width:65%"><!-- 内容 -->
                            <col style="width:10%"><!-- カテゴリ / 状態 -->
                            <col style="width:9%"><!-- アクション -->
                        </colgroup>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @foreach ($boards as $board)
                                <tr id="post-{{ $board->id }}">
                                    <td class="px-6 py-4 align-top">
                                        <div class="flex items-center justify-center space-x-3">
                                            <div class="text-xs text-gray-400">{{ $board->created_at->format('Y-m-d') }}</div>
                                            <div class="text-sm text-gray-500">{{ $board->created_at->format('H:i') }}</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 align-top">
                                        <div class="text-center text-sm font-medium text-gray-900">{{ $board->user->name ?? '不明' }}</div>
                                    </td>
                                    <td class="px-6 py-4 align-top" style="vertical-align:top;">
                                        <div id="board-view-{{ $board->id }}" class="text-sm text-gray-700 whitespace-normal break-words leading-relaxed">
                                            {!! nl2br(e($board->description)) !!}
                                            @if(method_exists($board, 'attachments') && $board->attachments->isNotEmpty())
                                                <ul class="mt-2 space-y-1">
                                                    @foreach($board->attachments as $file)
                                                        <li class="flex items-center space-x-2">
                                                            <a href="{{ route('attachments.show', $file) }}" class="text-blue-600 underline">{{ $file->filename }}</a>
                                                            <span class="text-gray-500 ml-2">({{ $file->created_at->format('Y-m-d') }})</span>
                                                        </li>
                                                    @endforeach
                                                </ul>
                                            @endif
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 align-top">
                                        @php
                                            $s = $board->status;
                                            switch ($s) {
                                                case 'pending':
                                                    $label = '保留中';
                                                    $badgeClass = 'bg-yellow-100 text-yellow-800';
                                                    break;
                                                case 'ongoing':
                                                    $label = '継続中';
                                                    $badgeClass = 'bg-blue-100 text-blue-800';
                                                    break;
                                                case 'done':
                                                    $label = '完了';
                                                    $badgeClass = 'bg-green-100 text-green-800';
                                                    break;
                                                default:
                                                    $label = $s ?: '—';
                                                    $badgeClass = 'bg-gray-100 text-gray-700';
                                                    break;
                                            }
                                        @endphp
                                        <div class="text-center">
                                            <span id="board-status-{{ $board->id }}" class="inline-block px-2 py-1 text-xs rounded {{ $badgeClass }}">{{ $label }}</span>
                                        </div>
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
                
                @if ($boards instanceof \Illuminate\Pagination\LengthAwarePaginator)
                    <div class="mt-4">
                        {{ $boards->links() }}
                    </div>
                @endif

                @else
                    <p class="text-gray-500">該当する投稿はありません。</p>
                @endif

            </div>
        </div>
    </div>

```







