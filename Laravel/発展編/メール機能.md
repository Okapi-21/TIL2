### メール機能実装

------

[TOC]

### SendGrid API

　SendGridはメール（eメール）を大量に、安全・確実に送信できるクラウドサービスのこと。

webサービス上からメールを大量送信することができるのが強みであり、httpsをsmtpに変換する機関である。

＊なお、sendgridが受け持つのはhttps→smtpのプロトコル変換及びメール送信のみであるので、txtやcnameについては独自ドメインで取得を行う必要がある



#### 実装手順

1. ##### SendGridにサインイン（アカウント追加）

   1. SendGridの公式サイト（https://sendgrid.com/en-us）にアクセス
   2. 追加したいwebサイトのFQDNを入力
   3. DNSレコードの追加
   4. APIキーの発行

2. ##### LaravelのプロジェクトにSendGridパッケージをインストール

   ```bash
   composer require sendgrid/sendgrid
   ```

3. ##### .envファイルの設定

   ```.env
   MAIL_MAILER=smtp
   MAIL_HOST=smtp.sendgrid.net
   MAIL_PORT=587
   MAIL_USERNAME=apikey #これはそのままでOKです。
   MAIL_PASSWORD=取得したAPIキー　#ここは変更
   MAIL_ENCRYPTION=tls
   MAIL_FROM_ADDRESS=あなたの送信元メールアドレス　#ここは変更
   MAIL_FROM_NAME="送信者名"　#ここは変更
   ```

   ------

   **Point**

   ここで一度、APIキーを使用して、きちんとメール送信ができているのかをテストしてみる

   ```bash
   php artisan tinker 
   ```

   tinker 内に入ってから

   ```php
   use Illuminate\Support\Facades\Mail;
   
   Mail::raw('これはテストメールです', function ($message) {
       $message->to('受信先メールアドレス'); // 実際に受け取りたいメールアドレス
       $message->subject('テスト送信');
   });
   ```

   これできちんとメールが送信されていればOKです。

4. ##### web.routeの設定

   > [!NOTE]
   >
   > 今回は投稿保存時にe-mail発信の有無をチェックボックスで設定する方法だったのでルート設定の必要なし
   >
   > ただ、別画面でe-mail発信を行いたい場合やe-mail発信専用の操作を行いたい場合はルート設定の必要あり

5. ##### コントローラーの設定

   読み込み要素の追加

   ```php
   use APP\Model\User;
   use Illuminate\Support\Facades\Mail;
   ```

   **point  【Facades（ファサード）】とは**

   > [!IMPORTANT]
   >
   > とても簡単にいうと...**「便利な入り口」**です！
   >
   > Laravelで機能しているもの（メール送信、DB操作、ファイル管理）は本当は裏側でとても複雑な仕組みで動いているが、
   >
   > 直接そのコードを触りに行くのはめちゃくちゃ大変なので、Facadesを使用して、それを簡単に使用・カスタマイズできるようにしています。
   >
   > 
   >
   > ＊gemとかcomposer とかと違うのは、gem・composer が外部機能（ライブラリ）をプロジェクトにインストールする仕組みであるのに対して、Facadesは「Laravelの中にある機能やサービス」を簡単な書き方で呼び出せるシステムのことを指しているという点です。

   

   storeメソッド中に以下の記述を追加する

   ```php
   if ($request->input('send_mail')){
               $user = auth()->user(); //ログインユーザーしているユーザーの情報を変数代入
               $userName = $user->name;　//ユーザー名を変数代入
               $userEmail = $user->email;　//ユーザーのemailを変数代入
   
               $emails = User::Pluck('email')->toArray();　//全ユーザーのemailの配列化
   
               //共有URLの生成
               $date = $board->created_at->toDateString();
               $url = url('/boards?date='.$date.'#post-'.$board->id);
   
               $body = "{$userName}が投稿を共有しました。\n\n投稿内容:\n{$board->description}\n\n投稿へのリンク:\n{$url}";
               
               Mail::raw($body.'が投稿を共有しました', function($message) use($emails, $userName, $userEmail, $body){
                   $message->to($emails);
                   $message->from($userEmail);
                   $message->subject('【iShare_投稿共有】'.$userName.'が投稿を共有しました');
               });
           }
   ```

   **point  【Pluck（プラック）】**

   > [!IMPORTANT]
   >
   > ```php
   > $emails = User::Pluck('email')->toArray();
   > ```
   >
   > Pluck：指定したカラムだけを全部、取り出して配列にするメソッドのこと
   >
   > 本機能では投稿を全員に共有したいので、一度全ユーザーのemailのみを取り出して、配列化している。

   **point  【toDateString()】**

   > [!IMPORTANT]
   >
   > ```php
   >  $date = $board->created_at->toDateString();
   > ```
   >
   > toDateString()：日時などのデータから「日付だけ」（2025-10-21 など）を取り出すための関数

   **point【Mail】**

   > [!TIP]
   >
   > ```php
   > // bodyがmailの内容
   > Mail::raw($body, function($message) use($emails, $userName, $userEmail, $body){
   >                 $message->to($emails); // 送信先
   >                 $message->from($userEmail);　// 送信元
   >                 $message->subject('【iShare_投稿共有】'.$userName.'が投稿を共有しました');　//件名
   >             });
   > ```

6. ##### View（index.blade.php）の切り替え

   ```html
   <!-- 入力欄に追加 -->
   <div class="flex items-center mt-6">
       <input type="checkbox" id="send_mail" name="send_mail" value="1" class="mr-2">
          <label for="send_mail" class="text-sm font-medium text-gray-700">投稿時にメール送信する</label>
   </div>
   ```

   チェックボックス形式でemail送信が可能なようにする

   コントローラーの【input(send_mail)】と対応させる
